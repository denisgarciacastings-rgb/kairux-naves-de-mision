<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H-01: El Forjador de Misi√≥n | Kairux</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Paleta Pilar Estrat√©gico - Azul-Violeta */
            --strategic-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --strategic-primary: #667eea;
            --strategic-secondary: #764ba2;
            
            /* Glass morphism - Enhanced */
            --glass-bg: rgba(255, 255, 255, 0.12);
            --glass-border: rgba(255, 255, 255, 0.18);
            --glass-hover: rgba(255, 255, 255, 0.16);
            
            /* Colores funcionales */
            --text-primary: #ffffff;
            --text-secondary: rgba(255, 255, 255, 0.7);
            --text-muted: rgba(255, 255, 255, 0.5);
            --accent-gold: #FFAB00;
            
            /* Sombras premium */
            --shadow-lg: 0 25px 50px -12px rgba(0, 0, 0, 0.8);
            --shadow-xl: 0 35px 60px -12px rgba(0, 0, 0, 0.9);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--strategic-gradient);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Main Container - AirDev Compatible */
        .forjador-container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            width: 100%;
        }

        /* Header */
        .header {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--glass-border);
            padding: 1.5rem 2rem;
            position: relative;
            flex-shrink: 0;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 1px;
            background: var(--strategic-gradient);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo {
            width: 50px;
            height: 50px;
            background: var(--strategic-gradient);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .brand-info h1 {
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 1.5rem;
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.25rem;
        }

        .tool-subtitle {
            font-size: 0.85rem;
            color: var(--text-muted);
            font-weight: 400;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .plan-badge {
            background: var(--strategic-gradient);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 25px;
            font-size: 0.8rem;
            font-weight: 600;
            font-family: 'Montserrat', sans-serif;
        }

        .help-button {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .help-button:hover {
            background: rgba(255, 255, 255, 0.2);
            color: var(--text-primary);
            transform: scale(1.05);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 2rem;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }

        /* Mural Container */
        .mural-container {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 25px;
            padding: 2.5rem;
            margin-bottom: 2rem;
            position: relative;
            overflow: hidden;
        }

        .mural-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: var(--strategic-gradient);
        }

        .mural-header {
            text-align: center;
            margin-bottom: 3rem;
        }

        .mural-title {
            font-family: 'Montserrat', sans-serif;
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 1rem;
            background: var(--strategic-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .mural-subtitle {
            font-size: 1.1rem;
            color: var(--text-secondary);
            line-height: 1.6;
            max-width: 600px;
            margin: 0 auto;
        }

        /* Mural Grid */
        .mural-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 2rem;
            margin-bottom: 3rem;
        }

        .mural-section {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 2rem;
            position: relative;
            transition: all 0.3s ease;
            min-height: 300px;
            display: flex;
            flex-direction: column;
        }

        .mural-section:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .section-icon {
            width: 50px;
            height: 50px;
            background: var(--strategic-gradient);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .section-title {
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 1.3rem;
            color: var(--text-primary);
        }

        .section-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .content-textarea {
            width: 100%;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            padding: 1.5rem;
            color: var(--text-primary);
            font-size: 1rem;
            font-family: inherit;
            line-height: 1.6;
            resize: none;
            min-height: 150px;
            flex: 1;
            transition: all 0.3s ease;
        }

        .content-textarea:focus {
            outline: none;
            border-color: var(--strategic-primary);
            background: rgba(255, 255, 255, 0.08);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
        }

        .content-textarea::placeholder {
            color: var(--text-muted);
            font-style: italic;
        }

        .section-helper {
            margin-top: 1rem;
            font-size: 0.8rem;
            color: var(--text-muted);
            font-style: italic;
        }

        /* Character Counter */
        .char-counter {
            text-align: right;
            margin-top: 0.5rem;
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .action-btn {
            background: var(--strategic-gradient);
            border: none;
            border-radius: 15px;
            padding: 1rem 2.5rem;
            color: white;
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .action-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 30px rgba(102, 126, 234, 0.4);
        }

        .action-btn.secondary {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .action-btn.secondary:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Preview Modal */
        .preview-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 2rem;
        }

        .preview-modal.active {
            display: flex;
        }

        .preview-content {
            background: white;
            border-radius: 25px;
            padding: 3rem;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: var(--shadow-xl);
        }

        .preview-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 2rem;
            color: #666;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .preview-close:hover {
            background: #f0f0f0;
            color: #333;
        }

        .preview-header {
            text-align: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #f0f0f0;
        }

        .preview-header h2 {
            color: var(--strategic-secondary);
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .preview-header p {
            color: #666;
            font-size: 1.1rem;
        }

        .preview-section {
            margin-bottom: 2rem;
            padding: 1.5rem;
            border-radius: 15px;
            border-left: 4px solid var(--strategic-primary);
        }

        .preview-section:nth-child(odd) {
            background: #f8f9ff;
        }

        .preview-section:nth-child(even) {
            background: #fff8f8;
            border-left-color: var(--strategic-secondary);
        }

        .preview-section h3 {
            color: var(--strategic-secondary);
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
            font-size: 1.3rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .preview-section p {
            color: #333;
            line-height: 1.8;
            font-size: 1rem;
        }

        /* Success Messages */
        .success-message {
            position: fixed;
            top: 100px;
            right: 2rem;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 15px;
            padding: 1rem 1.5rem;
            color: var(--text-primary);
            transform: translateX(400px);
            transition: transform 0.3s ease;
            z-index: 1000;
            min-width: 300px;
        }

        .success-message.show {
            transform: translateX(0);
        }

        .success-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--accent-gold);
        }

        .success-text {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        /* Methodology Guide */
        .methodology-guide {
            background: rgba(255, 171, 0, 0.1);
            border: 1px solid rgba(255, 171, 0, 0.3);
            border-radius: 20px;
            padding: 2rem;
            margin-top: 2rem;
        }

        .methodology-title {
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 1.2rem;
            color: var(--accent-gold);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .methodology-content {
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .methodology-steps {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        .step-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 1.5rem;
            text-align: center;
        }

        .step-number {
            background: var(--accent-gold);
            color: #1a1a2e;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            margin: 0 auto 1rem;
        }

        .step-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .step-description {
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }

            .header-actions {
                width: 100%;
                justify-content: space-between;
            }

            .main-content {
                padding: 1rem;
            }

            .mural-container {
                padding: 1.5rem;
            }

            .mural-grid {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }

            .mural-title {
                font-size: 2rem;
            }

            .action-buttons {
                flex-direction: column;
                align-items: center;
            }

            .action-btn {
                width: 100%;
                max-width: 300px;
                justify-content: center;
            }

            .methodology-steps {
                grid-template-columns: 1fr;
            }

            .preview-content {
                padding: 2rem;
                margin: 1rem;
            }
        }

        /* Plan Restrictions */
        .plan-restricted {
            position: relative;
            opacity: 0.4;
            pointer-events: none;
        }

        .plan-upgrade-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--strategic-gradient);
            color: white;
            padding: 1rem 2rem;
            border-radius: 15px;
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
            text-align: center;
            cursor: pointer;
            z-index: 10;
            transition: all 0.3s ease;
        }

        .plan-upgrade-overlay:hover {
            transform: translate(-50%, -50%) scale(1.05);
        }

        /* Auto-save indicator - Reposicionado para evitar cortes */
        .auto-save-indicator {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 25px;
            padding: 0.75rem 1.5rem;
            color: var(--text-secondary);
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transform: translateY(100px);
            transition: transform 0.3s ease;
            z-index: 1000;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }

        .auto-save-indicator.show {
            transform: translateY(0);
        }

        .save-status {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--accent-gold);
            animation: pulse 2s infinite;
        }

        .save-status.saved {
            background: #4CAF50;
            animation: none;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.1); }
        }

        /* Typography improvements */
        .content-textarea {
            font-size: 1.1rem;
            line-height: 1.8;
        }

        .section-helper {
            font-size: 0.85rem;
            line-height: 1.4;
        }

        /* Enhanced focus states */
        .mural-section:focus-within {
            border-color: var(--strategic-primary);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
        }
    </style>
</head>
<body>
    <div class="forjador-container">
        <!-- Header -->
        <div class="header">
            <div class="header-content">
                <div class="logo-section">
                    <div class="logo">üéØ</div>
                    <div class="brand-info">
                        <h1>KAIRUX</h1>
                        <div class="tool-subtitle">H-01: El Forjador de Misi√≥n</div>
                    </div>
                </div>
                
                <div class="header-actions">
                    <div class="help-button" onclick="toggleHelp()" title="Ayuda">?</div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Mural de Cultura -->
            <div class="mural-container">
                <div class="mural-header">
                    <h2 class="mural-title">Mural de Cultura Interactivo</h2>
                    <p class="mural-subtitle">
                        Define el "alma" de su empresa. Estos cuatro pilares guiar√°n cada decisi√≥n futura y se convertir√°n en su br√∫jula estrat√©gica.
                    </p>
                </div>

                <div class="mural-grid">
                    <!-- Prop√≥sito -->
                    <div class="mural-section" id="proposito">
                        <div class="section-header">
                            <div class="section-icon">üåü</div>
                            <div class="section-title">Prop√≥sito</div>
                        </div>
                        <div class="section-content">
                            <textarea 
                                class="content-textarea" 
                                id="propositoText"
                                placeholder="¬øPor qu√© existe su empresa? ¬øCu√°l es la causa que le impulsa cada d√≠a?&#10;&#10;Ejemplo: 'Democratizar el acceso a tecnolog√≠a de calidad para que las peque√±as empresas compitan en igualdad de condiciones.'"
                                maxlength="500"
                                oninput="autoSave('proposito', this.value); updateCharCount('proposito', this.value)"
                            ></textarea>
                            <div class="char-counter">
                                <span id="propositoCount">0</span>/500 caracteres
                            </div>
                            <div class="section-helper">
                                El prop√≥sito es su "por qu√©". Debe inspirar y conectar emocionalmente con su equipo y clientes.
                            </div>
                        </div>
                    </div>

                    <!-- Valores -->
                    <div class="mural-section" id="valores">
                        <div class="section-header">
                            <div class="section-icon">‚öñÔ∏è</div>
                            <div class="section-title">Valores</div>
                        </div>
                        <div class="section-content">
                            <textarea 
                                class="content-textarea" 
                                id="valoresText"
                                placeholder="¬øCu√°les son los principios inquebrantables que gu√≠an sus acciones?&#10;&#10;Ejemplo: 'Honestidad radical, Excelencia sin excusas, Colaboraci√≥n genuina, Innovaci√≥n constante.'"
                                maxlength="400"
                                oninput="autoSave('valores', this.value); updateCharCount('valores', this.value)"
                            ></textarea>
                            <div class="char-counter">
                                <span id="valoresCount">0</span>/400 caracteres
                            </div>
                            <div class="section-helper">
                                Los valores son sus l√≠neas rojas. Defina 3-5 principios que nunca comprometer√≠a.
                            </div>
                        </div>
                    </div>

                    <!-- Misi√≥n -->
                    <div class="mural-section" id="mision">
                        <div class="section-header">
                            <div class="section-icon">üöÄ</div>
                            <div class="section-title">Misi√≥n</div>
                        </div>
                        <div class="section-content">
                            <textarea 
                                class="content-textarea" 
                                id="misionText"
                                placeholder="¬øQu√© hace concretamente para cumplir su prop√≥sito?&#10;&#10;Ejemplo: 'Desarrollamos software intuitivo y accesible que simplifica las operaciones empresariales, permitiendo que los emprendedores se enfoquen en lo que realmente importa: hacer crecer su negocio.'"
                                maxlength="600"
                                oninput="autoSave('mision', this.value); updateCharCount('mision', this.value)"
                            ></textarea>
                            <div class="char-counter">
                                <span id="misionCount">0</span>/600 caracteres
                            </div>
                            <div class="section-helper">
                                La misi√≥n es su "qu√©". Debe ser espec√≠fica y describir el impacto actual que genera.
                            </div>
                        </div>
                    </div>

                    <!-- Visi√≥n -->
                    <div class="mural-section" id="vision">
                        <div class="section-header">
                            <div class="section-icon">üî≠</div>
                            <div class="section-title">Visi√≥n</div>
                        </div>
                        <div class="section-content">
                            <textarea 
                                class="content-textarea" 
                                id="visionText"
                                placeholder="¬øC√≥mo se ve el futuro que quiere crear?&#10;&#10;Ejemplo: 'Un mundo donde cada emprendedor, sin importar su tama√±o o recursos, tenga acceso a las herramientas digitales necesarias para construir un negocio pr√≥spero y sostenible.'"
                                maxlength="500"
                                oninput="autoSave('vision', this.value); updateCharCount('vision', this.value)"
                            ></textarea>
                            <div class="char-counter">
                                <span id="visionCount">0</span>/500 caracteres
                            </div>
                            <div class="section-helper">
                                La visi√≥n es su "hacia d√≥nde". Debe ser inspiradora y describir el impacto a largo plazo.
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="action-btn secondary" onclick="clearAll()">
                        üîÑ Empezar de Nuevo
                    </button>
                    <button class="action-btn" onclick="previewMural()">
                        üëÅÔ∏è Vista Previa
                    </button>
                    <button class="action-btn" onclick="shareMural()">
                        üì§ Compartir con Equipo
                    </button>
                </div>
            </div>

            <!-- Metodolog√≠a Guide -->
            <div class="methodology-guide">
                <div class="methodology-title">
                    üí° Metodolog√≠a "Valores Vivos"
                </div>
                <div class="methodology-content">
                    <p>¬øSu equipo ya complet√≥ el diagn√≥stico participativo? Use estos pasos para crear una filosof√≠a empresarial aut√©ntica que realmente se viva:</p>
                </div>
                
                <div class="methodology-steps">
                    <div class="step-card">
                        <div class="step-number">1</div>
                        <div class="step-title">Diagn√≥stico An√≥nimo</div>
                        <div class="step-description">Env√≠e el "Taller de Valores Existenciales" a su equipo</div>
                    </div>
                    
                    <div class="step-card">
                        <div class="step-number">2</div>
                        <div class="step-title">Co-creaci√≥n</div>
                        <div class="step-description">Realiza el taller de s√≠ntesis con herramientas colaborativas</div>
                    </div>
                    
                    <div class="step-card">
                        <div class="step-number">3</div>
                        <div class="step-title">Implementaci√≥n</div>
                        <div class="step-description">Use el Kit "Filosof√≠a Viva" para que se convierta en h√°bitos</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Preview Modal -->
        <div class="preview-modal" id="previewModal">
            <div class="preview-content">
                <button class="preview-close" onclick="closePreview()">√ó</button>
                <div class="preview-header">
                    <h2 id="companyName">Mi Empresa</h2>
                    <p>Filosof√≠a Empresarial</p>
                </div>
                <div id="previewSections"></div>
                <div style="text-align: center; margin-top: 2rem;">
                    <button class="action-btn" onclick="exportToPDF()">
                        üìÑ Descargar PDF
                    </button>
                    <button class="action-btn secondary" onclick="exportToImage()">
                        üñºÔ∏è Descargar Imagen
                    </button>
                </div>
            </div>
        </div>

        <!-- Success Message -->
        <div class="success-message" id="successMessage">
            <div class="success-title">‚úÖ Guardado autom√°ticamente</div>
            <div class="success-text">Tus cambios se han sincronizado con la base de datos</div>
        </div>

        <!-- Auto-save Indicator -->
        <div class="auto-save-indicator" id="autoSaveIndicator">
            <div class="save-status" id="saveStatus"></div>
            <span id="saveText">Guardando...</span>
        </div>
    </div>

    <script>
        // Plan Configuration System
        const planConfig = {
            ESENCIAL: {
                features: ['basic-mural'],
                maxSections: 4,
                canExport: true,
                canShare: false
            },
            CRECIMIENTO: {
                features: ['full-mural', 'methodology-guide'],
                maxSections: 4,
                canExport: true,
                canShare: true
            },
            PREMIUM: {
                features: ['everything'],
                maxSections: 4,
                canExport: true,
                canShare: true,
                hasAdvancedTemplates: true
            },
            ELITE: {
                features: ['everything'],
                maxSections: 4,
                canExport: true,
                canShare: true,
                hasAdvancedTemplates: true,
                hasCustomBranding: true
            }
        };

        // Current configuration (from Bubble)
        let currentPlan = 'ESENCIAL';
        let companyData = {
            name: '',
            proposito: '',
            valores: '',
            mision: '',
            vision: ''
        };

        let autoSaveTimeout;
        let hasChanges = false;

        // Initialize Application
        function initializeApp() {
            applyPlanRestrictions();
            loadExistingData();
            startAutoSaveIndicator();
            
            // Show welcome message for first-time users
            if (isFirstTimeUser()) {
                showWelcomeMessage();
            }
            
            console.log('üéØ H-01: El Forjador de Misi√≥n - Kairux Activado');
            console.log('üìù Auto-guardado cada 3 segundos');
            console.log('üîÑ Integraci√≥n con ecosistema Kairux preparada');
        }

        function applyPlanRestrictions() {
            const config = planConfig[currentPlan];
            document.getElementById('currentPlan').textContent = currentPlan;
            
            // Apply sharing restrictions
            if (!config.canShare) {
                const shareBtn = document.querySelector('[onclick="shareMural()"]');
                shareBtn.classList.add('plan-restricted');
                shareBtn.onclick = () => showUpgradeModal('compartir con el equipo');
            }
        }

        function autoSave(section, value) {
            companyData[section] = value;
            hasChanges = true;
            
            // Show saving indicator
            showSaveIndicator('saving');
            
            // Clear existing timeout
            clearTimeout(autoSaveTimeout);
            
            // Set new timeout for auto-save
            autoSaveTimeout = setTimeout(() => {
                saveToDatabase();
            }, 3000);
        }

        function saveToDatabase() {
            if (!hasChanges) return;
            
            // Simulate API call to Bubble/Workspace
            const saveData = {
                timestamp: new Date().toISOString(),
                pilar: 'Gesti√≥n Estrat√©gica',
                herramienta: 'H-01: El Forjador de Misi√≥n',
                data: companyData,
                plan: currentPlan
            };
            
            // In real implementation, this would call the Workspace API
            console.log('üíæ Guardando en base de datos:', saveData);
            
            // Simulate successful save
            setTimeout(() => {
                showSaveIndicator('saved');
                showSuccessMessage('Filosof√≠a empresarial guardada correctamente');
                hasChanges = false;
                
                // Call Bubble function if available
                if (typeof bubble_fn_saveMissionData === 'function') {
                    bubble_fn_saveMissionData(saveData);
                }
            }, 1000);
        }

        function loadExistingData() {
            // In real implementation, this would load from Workspace
            // For now, check localStorage for demo purposes
            const existingData = localStorage.getItem('kairux_h01_data');
            if (existingData) {
                const data = JSON.parse(existingData);
                companyData = data;
                
                // Populate form fields
                document.getElementById('propositoText').value = data.proposito || '';
                document.getElementById('valoresText').value = data.valores || '';
                document.getElementById('misionText').value = data.mision || '';
                document.getElementById('visionText').value = data.vision || '';
                
                // Update character counts
                updateCharCount('proposito', data.proposito || '');
                updateCharCount('valores', data.valores || '');
                updateCharCount('mision', data.mision || '');
                updateCharCount('vision', data.vision || '');
            }
        }

        function updateCharCount(section, text) {
            const counter = document.getElementById(section + 'Count');
            if (counter) {
                counter.textContent = text.length;
                
                // Color coding for character limits
                const maxLength = parseInt(counter.parentElement.textContent.match(/\/(\d+)/)[1]);
                const percentage = (text.length / maxLength) * 100;
                
                if (percentage > 90) {
                    counter.style.color = '#ff5252';
                } else if (percentage > 75) {
                    counter.style.color = '#ff9800';
                } else {
                    counter.style.color = 'var(--text-muted)';
                }
            }
        }

        function showSaveIndicator(status) {
            const indicator = document.getElementById('autoSaveIndicator');
            const statusDot = document.getElementById('saveStatus');
            const statusText = document.getElementById('saveText');
            
            indicator.classList.add('show');
            
            if (status === 'saving') {
                statusDot.classList.remove('saved');
                statusText.textContent = 'Guardando...';
            } else if (status === 'saved') {
                statusDot.classList.add('saved');
                statusText.textContent = 'Guardado';
                
                // Hide after 3 seconds
                setTimeout(() => {
                    indicator.classList.remove('show');
                }, 3000);
            }
        }

        function showSuccessMessage(message) {
            const successMsg = document.getElementById('successMessage');
            const successText = successMsg.querySelector('.success-text');
            successText.textContent = message;
            
            successMsg.classList.add('show');
            setTimeout(() => {
                successMsg.classList.remove('show');
            }, 4000);
        }

        function clearAll() {
            if (confirm('¬øEst√° seguro de que quiere borrar todo el contenido? Esta acci√≥n no se puede deshacer.')) {
                companyData = { proposito: '', valores: '', mision: '', vision: '' };
                
                document.getElementById('propositoText').value = '';
                document.getElementById('valoresText').value = '';
                document.getElementById('misionText').value = '';
                document.getElementById('visionText').value = '';
                
                updateCharCount('proposito', '');
                updateCharCount('valores', '');
                updateCharCount('mision', '');
                updateCharCount('vision', '');
                
                hasChanges = true;
                saveToDatabase();
                
                showSuccessMessage('Mural reiniciado correctamente');
            }
        }

        function previewMural() {
            const modal = document.getElementById('previewModal');
            const previewSections = document.getElementById('previewSections');
            
            // Build preview content
            const sections = [
                { title: 'Prop√≥sito', content: companyData.proposito, icon: 'üåü' },
                { title: 'Valores', content: companyData.valores, icon: '‚öñÔ∏è' },
                { title: 'Misi√≥n', content: companyData.mision, icon: 'üöÄ' },
                { title: 'Visi√≥n', content: companyData.vision, icon: 'üî≠' }
            ];
            
            previewSections.innerHTML = sections.map(section => `
                <div class="preview-section">
                    <h3>${section.icon} ${section.title}</h3>
                    <p>${section.content || 'Sin contenido definido a√∫n.'}</p>
                </div>
            `).join('');
            
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closePreview() {
            const modal = document.getElementById('previewModal');
            modal.classList.remove('active');
            document.body.style.overflow = 'auto';
        }

        function shareMural() {
            const config = planConfig[currentPlan];
            if (!config.canShare) {
                showUpgradeModal('compartir con el equipo');
                return;
            }
            
            // Generate shareable link or export functionality
            const shareData = {
                title: 'Filosof√≠a Empresarial',
                text: 'Revisa nuestra filosof√≠a empresarial actualizada',
                url: window.location.href
            };
            
            if (navigator.share) {
                navigator.share(shareData);
            } else {
                // Fallback: copy to clipboard
                const shareUrl = `${window.location.origin}/share/mural/${btoa(JSON.stringify(companyData))}`;
                navigator.clipboard.writeText(shareUrl).then(() => {
                    showSuccessMessage('Enlace copiado al portapapeles');
                });
            }
        }

        function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF();
            
            // Add title
            pdf.setFontSize(20);
            pdf.setFont('helvetica', 'bold');
            pdf.text('Filosof√≠a Empresarial', 20, 30);
            
            // Add sections
            let yPosition = 50;
            const sections = [
                { title: 'Prop√≥sito', content: companyData.proposito },
                { title: 'Valores', content: companyData.valores },
                { title: 'Misi√≥n', content: companyData.mision },
                { title: 'Visi√≥n', content: companyData.vision }
            ];
            
            sections.forEach(section => {
                if (section.content) {
                    pdf.setFontSize(14);
                    pdf.setFont('helvetica', 'bold');
                    pdf.text(section.title, 20, yPosition);
                    yPosition += 10;
                    
                    pdf.setFontSize(11);
                    pdf.setFont('helvetica', 'normal');
                    const lines = pdf.splitTextToSize(section.content, 170);
                    pdf.text(lines, 20, yPosition);
                    yPosition += lines.length * 5 + 15;
                    
                    if (yPosition > 250) {
                        pdf.addPage();
                        yPosition = 30;
                    }
                }
            });
            
            // Add footer
            pdf.setFontSize(8);
            pdf.setFont('helvetica', 'italic');
            pdf.text('Generado por Kairux - Sistema de Gesti√≥n Empresarial', 20, 280);
            
            pdf.save('filosofia-empresarial.pdf');
            showSuccessMessage('PDF descargado correctamente');
        }

        function exportToImage() {
            const previewContent = document.querySelector('.preview-content');
            
            html2canvas(previewContent, {
                backgroundColor: '#ffffff',
                scale: 2,
                useCORS: true
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = 'filosofia-empresarial.png';
                link.href = canvas.toDataURL();
                link.click();
                
                showSuccessMessage('Imagen descargada correctamente');
            });
        }

        function showUpgradeModal(feature) {
            const message = `Para ${feature}, necesita actualizar su plan. ¬øLe gustar√≠a conocer las opciones disponibles?`;
            if (confirm(message)) {
                // Redirect to upgrade page or show upgrade modal
                console.log('Redirigiendo a p√°gina de upgrade...');
                if (typeof bubble_fn_showUpgrade === 'function') {
                    bubble_fn_showUpgrade(currentPlan, feature);
                }
            }
        }

        function toggleHelp() {
            // Show help overlay or modal
            alert(`H-01: El Forjador de Misi√≥n

Esta herramienta te ayuda a definir el "alma" de tu empresa de manera estructurada:

üåü PROP√ìSITO: Tu "por qu√©" - la causa que te impulsa
‚öñÔ∏è VALORES: Tus principios inquebrantables
üöÄ MISI√ìN: Tu "qu√©" - el impacto actual que generas
üî≠ VISI√ìN: Tu "hacia d√≥nde" - el futuro que quieres crear

üí° CONSEJO: Usa la metodolog√≠a "Valores Vivos" para co-crear estos elementos con tu equipo y asegurar que se conviertan en algo que realmente se viva, no solo se escriba.`);
        }

        function isFirstTimeUser() {
            return !localStorage.getItem('kairux_h01_visited');
        }

        function showWelcomeMessage() {
            localStorage.setItem('kairux_h01_visited', 'true');
            setTimeout(() => {
                showSuccessMessage('¬°Bienvenido al Forjador de Misi√≥n! Define el alma de tu empresa aqu√≠.');
            }, 1000);
        }

        function startAutoSaveIndicator() {
            // Show auto-save indicator periodically when there are changes
            setInterval(() => {
                if (hasChanges) {
                    showSaveIndicator('saving');
                }
            }, 30000); // Check every 30 seconds
        }

        // Export Functions for Kairux Ecosystem Integration
        function exportKairuxData() {
            return {
                pilar: 'Gesti√≥n Estrat√©gica',
                herramienta: 'H-01: El Forjador de Misi√≥n',
                data: {
                    proposito: companyData.proposito,
                    valores: companyData.valores,
                    mision: companyData.mision,
                    vision: companyData.vision,
                    completeness: calculateCompleteness(),
                    lastModified: new Date().toISOString()
                },
                integrations: {
                    h02_strategic_initiatives: generateStrategicInitiatives(),
                    h04_okr_objectives: generateOKRObjectives(),
                    philosophy_score: calculatePhilosophyScore()
                },
                timestamp: new Date().toISOString(),
                plan: currentPlan
            };
        }

        function calculateCompleteness() {
            const fields = [companyData.proposito, companyData.valores, companyData.mision, companyData.vision];
            const filledFields = fields.filter(field => field && field.trim().length > 0).length;
            return Math.round((filledFields / fields.length) * 100);
        }

        function generateStrategicInitiatives() {
            // This would feed into H-02: El Navegador Estrat√©gico
            const initiatives = [];
            if (companyData.proposito) {
                initiatives.push({
                    title: "Alineaci√≥n de Prop√≥sito",
                    description: "Asegurar que todas las actividades reflejen nuestro prop√≥sito",
                    priority: "HIGH",
                    source: "H-01"
                });
            }
            return initiatives;
        }

        function generateOKRObjectives() {
            // This would feed into H-04: El Gestor de OKRs
            const objectives = [];
            if (companyData.vision) {
                objectives.push({
                    objective: "Avanzar hacia nuestra visi√≥n empresarial",
                    keyResults: [
                        "Definir 3 iniciativas clave alineadas con la visi√≥n",
                        "Medir el progreso trimestralmente",
                        "Comunicar la visi√≥n a todo el equipo"
                    ],
                    source: "H-01"
                });
            }
            return objectives;
        }

        function calculatePhilosophyScore() {
            // Score based on completeness and quality indicators
            const completeness = calculateCompleteness();
            const qualityFactors = [
                companyData.proposito && companyData.proposito.length > 100,
                companyData.valores && companyData.valores.includes(','),
                companyData.mision && companyData.mision.length > 150,
                companyData.vision && companyData.vision.length > 100
            ].filter(Boolean).length;
            
            return Math.round((completeness * 0.7) + (qualityFactors * 7.5));
        }

        // Global functions for Bubble integration
        window.kairuxH01 = {
            exportData: exportKairuxData,
            updatePlan: (newPlan) => {
                currentPlan = newPlan;
                applyPlanRestrictions();
            },
            getData: () => companyData,
            setData: (data) => {
                companyData = { ...companyData, ...data };
                loadExistingData();
            },
            triggerSave: saveToDatabase,
            getCompleteness: calculateCompleteness,
            generatePDF: exportToPDF,
            sendToNavigator: () => {
                const strategicData = generateStrategicInitiatives();
                console.log('üìç Enviando datos a H-02:', strategicData);
                if (typeof bubble_fn_sendToH02 === 'function') {
                    bubble_fn_sendToH02(strategicData);
                }
                return strategicData;
            },
            sendToOKRManager: () => {
                const okrData = generateOKRObjectives();
                console.log('üéØ Enviando objetivos a H-04:', okrData);
                if (typeof bubble_fn_sendToH04 === 'function') {
                    bubble_fn_sendToH04(okrData);
                }
                return okrData;
            }
        };

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            
            // Prevent data loss on page unload
            window.addEventListener('beforeunload', function(e) {
                if (hasChanges) {
                    e.preventDefault();
                                                    e.returnValue = 'Tiene cambios sin guardar. ¬øEst√° seguro de que quiere salir?';
                }
            });
        });

        // Handle page visibility changes to save data
        document.addEventListener('visibilitychange', function() {
            if (document.hidden && hasChanges) {
                saveToDatabase();
            }
        });
    </script>
</body>
</html>