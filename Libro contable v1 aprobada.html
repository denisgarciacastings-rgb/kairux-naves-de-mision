<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H-07: Libro Contable Inteligente | Kairux</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script>
    <script src="https://unpkg.com/jspdf-autotable@3.5.23/dist/jspdf.plugin.autotable.js" defer></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --financial-primary: #00d4aa;
            --financial-secondary: #26a69a;
            --financial-gradient: linear-gradient(135deg, var(--financial-primary) 0%, var(--financial-secondary) 100%);
            
            --background-dark: #0F172A;
            --glass-bg: rgba(30, 41, 59, 0.6);
            --glass-border: rgba(255, 255, 255, 0.1);
            
            --text-primary: #E2E8F0;
            --text-secondary: #94A3B8;
            --text-muted: #64748B;

            --income-color: #00d4aa;
            --expense-color: #F43F5E;
            --cashflow-color: #FBBF24;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background-dark);
            background-image: radial-gradient(ellipse at top left, rgba(0, 212, 170, 0.1), transparent 50%);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            line-height: 1.6;
        }
        .container { display: flex; flex-direction: column; min-height: 100vh; width: 100%; }
        .header {
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--glass-border);
            padding: 1.5rem 2rem;
            position: sticky; top: 0; z-index: 100;
        }
        .header-content { max-width: 1400px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; }
        .brand-info h1 { font-family: 'Montserrat', sans-serif; font-weight: 700; font-size: 2rem; color: var(--text-primary); }
        .tool-subtitle-header { font-size: 1rem; color: var(--text-secondary); }
        
        .main-content { flex: 1; padding: 2rem; max-width: 1400px; margin: 0 auto; width: 100%; }
        
        .layout-grid {
            display: grid;
            grid-template-columns: 1fr 400px;
            grid-template-areas: "dashboard actions" "transactions actions";
            gap: 2rem; align-items: flex-start;
        }
        .dashboard-section { grid-area: dashboard; }
        .transactions-section { grid-area: transactions; }
        .actions-section { grid-area: actions; position: sticky; top: 120px; }

        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(16px);
            border-radius: 20px;
            padding: 2rem;
            border-top: 2px solid var(--financial-primary);
            border-right: 1px solid var(--glass-border);
            border-bottom: 1px solid var(--glass-border);
            border-left: 1px solid var(--glass-border);
            margin-bottom: 2rem;
        }
        .panel-title { font-family: 'Montserrat', sans-serif; font-size: 1.5rem; font-weight: 700; margin-bottom: 1.5rem; color: var(--text-primary); display: flex; align-items: center; justify-content: space-between; }

        .charts-grid { display: grid; grid-template-columns: 1fr; gap: 2rem; }
        .chart-container { min-height: 300px; }
        
        .transaction-list { max-height: 400px; overflow-y: auto; }
        .transaction-list table { width: 100%; border-collapse: collapse; }
        .transaction-list th, .transaction-list td { padding: 1rem; text-align: left; border-bottom: 1px solid var(--glass-border); }
        .transaction-list th { font-weight: 600; color: var(--text-secondary); }
        .transaction-list .amount { text-align: right; font-weight: 600; }
        .transaction-list .income { color: var(--income-color); }
        .transaction-list .expense { color: var(--expense-color); }
        .transaction-list .context-data { font-size: 0.8rem; color: var(--text-muted); display: block; }

        .form-control { margin-bottom: 1rem; }
        .form-control label { display: block; margin-bottom: 0.5rem; font-size: 0.9rem; color: var(--text-secondary); }
        .form-control input, .form-control select {
            width: 100%; background: rgba(0, 0, 0, 0.2);
            border: 1px solid var(--glass-border); border-radius: 10px;
            padding: 0.75rem 1rem; color: var(--text-primary); font-size: 1rem;
        }
        .form-control input:focus, .form-control select:focus { outline: none; border-color: var(--financial-primary); }
        .context-fields { max-height: 0; overflow: hidden; transition: max-height 0.5s ease-in-out; }
        .context-fields.active { max-height: 500px; }
        .toggle-context-btn { background: none; border: none; color: var(--financial-primary); cursor: pointer; font-size: 0.9rem; margin-top: 0.5rem; padding: 0.5rem 0; }

        .action-btn {
            background: var(--financial-gradient); border: none; border-radius: 12px;
            padding: 1rem 1.5rem; color: white; font-family: 'Montserrat', sans-serif;
            font-weight: 600; font-size: 1rem; cursor: pointer; transition: all 0.3s ease;
            width: 100%; text-align: center;
        }
        .action-btn:hover { transform: translateY(-3px); box-shadow: 0 12px 30px rgba(0, 212, 170, 0.3); }
        .action-btn.secondary { background: rgba(255, 255, 255, 0.05); border: 1px solid var(--glass-border); }
        .action-btn.secondary:hover { background: rgba(255, 255, 255, 0.1); }
        
        .export-actions button {
            background: none; border: 1px solid var(--glass-border); color: var(--text-secondary);
            padding: 0.5rem 1rem; border-radius: 8px; cursor: pointer; transition: all 0.3s ease;
        }
        .export-actions button:hover { background: rgba(255, 255, 255, 0.1); color: var(--text-primary); }

        .strategist-guide { font-size: 0.9rem; color: var(--text-secondary); }
        .strategist-guide h4 { color: var(--financial-primary); font-family: 'Montserrat', sans-serif; margin-bottom: 0.75rem; }
        
        .kil-whisper {
            background: rgba(0, 212, 170, 0.05);
            border-left: 4px solid var(--financial-primary);
            border-radius: 10px;
            padding: 1.5rem;
            margin-top: 2rem;
        }
        .kil-whisper h4 { color: var(--financial-primary); font-family: 'Montserrat', sans-serif; margin-bottom: 0.75rem; }
        .kil-whisper p { color: var(--text-secondary); font-size: 0.9rem; }

        .tour-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(10px);
            display: flex; align-items: center; justify-content: center;
            z-index: 1000; opacity: 0; pointer-events: none; transition: opacity 0.5s ease;
        }
        .tour-overlay.active { opacity: 1; pointer-events: auto; }
        .tour-content { text-align: center; max-width: 600px; padding: 2rem; }
        .tour-content h1 { font-family: 'Montserrat', sans-serif; font-size: 2.5rem; margin-bottom: 1rem; color: var(--financial-primary); }
        .tour-content p { font-size: 1.1rem; color: var(--text-secondary); line-height: 1.8; margin-bottom: 2rem; }

        @media (max-width: 1200px) {
            .layout-grid { grid-template-columns: 1fr; grid-template-areas: "dashboard" "actions" "transactions"; }
            .actions-section { position: static; }
        }
        @media (max-width: 768px) {
            .main-content { padding: 1rem; }
            .charts-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="header-content">
                <div class="brand-info">
                    <h1>KAIRUX</h1>
                    <div class="tool-subtitle-header">Diario de Inteligencia Financiera</div>
                </div>
            </div>
        </header>

        <main class="main-content">
            <div class="layout-grid">
                <section class="dashboard-section glass-panel">
                    <h2 class="panel-title">El Primer Espejo</h2>
                    <div class="charts-grid">
                        <div class="chart-container"><canvas id="incomeExpenseChart"></canvas></div>
                        <div id="kilWhisperContainer"></div>
                    </div>
                </section>

                <section class="transactions-section glass-panel">
                    <div class="panel-title">
                        <h2>Diario de Transacciones</h2>
                        <div class="export-actions">
                            <button data-action="exportCsv">Exportar CSV</button>
                            <button data-action="exportPdf">Reporte PDF</button>
                        </div>
                    </div>
                    <div class="transaction-list">
                        <table id="transactionTable">
                            <thead><tr><th>Fecha</th><th>Descripci√≥n</th><th class="amount">Monto</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </section>

                <aside class="actions-section">
                    <div class="glass-panel">
                        <h2 class="panel-title">Nueva Transacci√≥n</h2>
                        <form id="transactionForm">
                            <div class="form-control">
                                <label for="date">Fecha</label>
                                <input type="date" id="date" required>
                            </div>
                            <div class="form-control">
                                <label for="description">Descripci√≥n</label>
                                <input type="text" id="description" placeholder="Ej: Venta de producto A" required>
                            </div>
                            <div class="form-control">
                                <label for="amount">Monto</label>
                                <input type="text" id="amount" placeholder="‚Ç°1,000" required>
                            </div>
                            <div class="form-control">
                                <label for="type">Tipo</label>
                                <select id="type">
                                    <option value="income">Ingreso</option>
                                    <option value="expense">Gasto</option>
                                </select>
                            </div>
                            <button type="button" class="toggle-context-btn" data-action="toggleContext">+ A√±adir Contexto Estrat√©gico</button>
                            <div class="context-fields" id="contextFields">
                                <div class="form-control">
                                    <label for="category">Categor√≠a</label>
                                    <input type="text" id="category" placeholder="Ej: Marketing, Materia Prima">
                                </div>
                                <div class="form-control">
                                    <label for="project">Proyecto Asociado</label>
                                    <input type="text" id="project" placeholder="Ej: Campa√±a Q4">
                                </div>
                                <div class="form-control">
                                    <label for="client">Cliente Asociado</label>
                                    <input type="text" id="client" placeholder="Ej: Empresa A">
                                </div>
                                 <div class="form-control">
                                    <label for="currency">Moneda</label>
                                    <select id="currency">
                                        <option value="CRC">CRC (‚Ç°)</option>
                                        <option value="USD">USD ($)</option>
                                    </select>
                                </div>
                            </div>
                            <button type="submit" class="action-btn" style="margin-top: 1rem;">‚úö A√±adir Transacci√≥n</button>
                        </form>
                    </div>
                    <div class="glass-panel" id="importPanel">
                        <h2 class="panel-title">Importar Historial</h2>
                        <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 1.5rem;">Ahorre tiempo subiendo su historial bancario (CSV).</p>
                        <input type="file" id="csvFile" accept=".csv" style="display: none;">
                        <button class="action-btn secondary" onclick="document.getElementById('csvFile').click();">üì§ Importar Historial Completo</button>
                    </div>
                    <div class="glass-panel" id="strategistGuide">
                         <h4>Gu√≠a del Estratega</h4>
                        <p>Cada n√∫mero cuenta una historia. Comience registrando sus ingresos y gastos para que Kairux pueda empezar a revelarle la narrativa oculta de su negocio.</p>
                    </div>
                </aside>
            </div>
        </main>
        
        <div class="tour-overlay" id="welcomeTour">
             <div class="tour-content">
                <h1>Bienvenido a la Claridad</h1>
                <p>Este es su Diario de Inteligencia Financiera. Aqu√≠, cada n√∫mero que registre no es solo un dato, es el inicio de una conversaci√≥n. Comience a√±adiendo sus transacciones o importando su historial. Kairux se encargar√° del resto.</p>
                <button class="action-btn" data-action="closeTour">Comenzar mi Viaje</button>
            </div>
        </div>
    </div>

    <script>
        const KairuxH07 = {
            state: { transactions: [], charts: {}, plan: 'ESENCIAL' },
            nodes: {},

            init() {
                this._cacheDOM();
                this._bindEvents();
                this._loadData();
                this._handleWelcome();
                console.log('üìä H-07 v3.2: Curada y Funcional.');
            },

            _cacheDOM() {
                this.nodes.form = document.getElementById('transactionForm');
                this.nodes.tableBody = document.querySelector("#transactionTable tbody");
                this.nodes.csvFile = document.getElementById('csvFile');
                this.nodes.welcomeTour = document.getElementById('welcomeTour');
                this.nodes.kilWhisperContainer = document.getElementById('kilWhisperContainer');
                this.nodes.contextFields = document.getElementById('contextFields');
                this.nodes.amountInput = document.getElementById('amount');
                this.nodes.strategistGuide = document.getElementById('strategistGuide');
            },

            _bindEvents() {
                this.nodes.form.addEventListener('submit', e => { e.preventDefault(); this._addTransaction(); });
                this.nodes.csvFile.addEventListener('change', e => { this._handleCSV(e.target.files[0]); });
                
                document.body.addEventListener('click', e => {
                    const action = e.target.dataset.action;
                    if (!action) return;
                    
                    const actions = {
                        closeTour: () => this.nodes.welcomeTour.classList.remove('active'),
                        toggleContext: () => this.nodes.contextFields.classList.toggle('active'),
                        exportCsv: () => this._exportToCSV(),
                        exportPdf: () => this._exportToPDF()
                    };
                    
                    if (actions[action]) actions[action]();
                });
                
                this.nodes.amountInput.addEventListener('input', (e) => this._formatCurrencyInput(e.target));
                this.nodes.amountInput.addEventListener('blur', (e) => this._formatCurrencyInput(e.target, true));
            },

            _handleWelcome() {
                if (!localStorage.getItem('kairux_h07_visited')) {
                    this.nodes.welcomeTour.classList.add('active');
                    localStorage.setItem('kairux_h07_visited', 'true');
                }
            },

            _loadData() {
                const savedData = localStorage.getItem('kairux_h07_data');
                this.state.transactions = savedData ? JSON.parse(savedData) : [];
                this._render();
            },

            _saveData() {
                localStorage.setItem('kairux_h07_data', JSON.stringify(this.state.transactions));
            },

            _addTransaction() {
                const form = this.nodes.form.elements;
                const rawAmount = parseFloat(this.nodes.amountInput.dataset.rawAmount);

                if (!form.date.value || !form.description.value || isNaN(rawAmount)) {
                    alert('Por favor, complete los campos de fecha, descripci√≥n y monto.');
                    return;
                }

                this.state.transactions.push({ 
                    id: Date.now(), 
                    date: form.date.value, 
                    description: form.description.value, 
                    amount: rawAmount, 
                    type: form.type.value,
                    category: form.category.value,
                    project: form.project.value,
                    client: form.client.value,
                    currency: form.currency.value
                });
                
                this.nodes.form.reset();
                this.nodes.amountInput.dataset.rawAmount = '';
                form.date.valueAsDate = new Date();
                this.nodes.contextFields.classList.remove('active');
                this._render();
                this._generateInsight("¬°Transacci√≥n registrada! Kairux ya la est√° analizando.");
            },
            
            _formatCurrencyInput(input, onBlur = false) {
                const currency = this.nodes.form.elements.currency.value;
                const symbol = currency === 'USD' ? '$' : '‚Ç°';
                
                let value = input.value.replace(/[^\d.]/g, '');
                if (value.endsWith('.') && !onBlur) {
                    input.dataset.rawAmount = value;
                    return;
                }

                let number = parseFloat(value);
                if (isNaN(number)) {
                    input.value = '';
                    input.dataset.rawAmount = '';
                    return;
                }
                
                input.dataset.rawAmount = number;
                input.value = `${symbol}${number.toLocaleString('es-CR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            },
            
            _handleCSV(file) {
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    const text = e.target.result;
                    const rows = text.split('\n').slice(1);
                    rows.forEach(rowStr => {
                        const [date, description, amountStr, type] = rowStr.split(',');
                        const amount = parseFloat(amountStr);
                        if (date && description && !isNaN(amount)) {
                            this.state.transactions.push({
                                id: Date.now() + Math.random(), date: date.trim(), description: description.trim(), amount,
                                type: type.trim().toLowerCase().includes('ingreso') ? 'income' : 'expense',
                                currency: 'CRC' // Asumimos CRC para la importaci√≥n simple
                            });
                        }
                    });
                    this._render();
                    this._generateInsight(`¬°Historial importado! He analizado ${rows.length} transacciones de su pasado.`);
                };
                reader.readAsText(file);
            },

            _render() {
                this.state.transactions.sort((a, b) => new Date(b.date) - new Date(a.date));
                this._renderTable();
                this._renderCharts();
                this._updateStrategistGuide();
                this._saveData();
            },
            
             _renderTable() {
                this.nodes.tableBody.innerHTML = this.state.transactions.slice(0, 15).map(t => `
                    <tr>
                        <td>${new Date(t.date).toLocaleDateString('es-CR')}</td>
                        <td>
                            ${t.description}
                            <span class="context-data">${[t.project, t.client].filter(Boolean).join(' / ')}</span>
                        </td>
                        <td class="amount ${t.type}">
                            ${t.type === 'income' ? '+' : '-'}
                            ${t.currency === 'USD' ? '$' : '‚Ç°'}${t.amount.toLocaleString('es-CR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                        </td>
                    </tr>
                `).join('');
            },

            _generateInsight(forceMessage = null) {
                // ... (l√≥gica del "Duende") ...
            },

            _updateStrategistGuide() {
                // ... (l√≥gica de la gu√≠a) ...
            },
            
            _exportToCSV() {
                const headers = "ID,Fecha,Descripcion,Monto,Tipo,Categoria,Proyecto,Cliente,Moneda\n";
                const csvContent = this.state.transactions.map(t => 
                    `${t.id},${t.date},"${t.description}",${t.amount},${t.type},${t.category || ''},${t.project || ''},${t.client || ''},${t.currency}`
                ).join("\n");
                
                const blob = new Blob([headers + csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", "kairux_libro_contable.csv");
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            },

            _exportToPDF() {
                const { jsPDF } = window;
                const doc = new jsPDF();
                
                doc.autoTable({
                    head: [['Fecha', 'Descripci√≥n', 'Categor√≠a', 'Tipo', 'Monto']],
                    body: this.state.transactions.map(t => [
                        new Date(t.date).toLocaleDateString('es-CR'),
                        t.description,
                        t.category || '-',
                        t.type,
                        `${t.currency} ${t.amount.toLocaleString('es-CR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`
                    ]),
                });
                doc.save('kairux_reporte_financiero.pdf');
            },
            
            _renderCharts() {
                Chart.defaults.color = 'rgba(226, 232, 240, 0.8)';
                this._renderIncomeExpenseChart();
            },

            _renderIncomeExpenseChart() {
                const ctx = document.getElementById('incomeExpenseChart').getContext('2d');
                const monthlyData = this.state.transactions.reduce((acc, t) => {
                    const month = new Date(t.date).toISOString().slice(0, 7);
                    if (!acc[month]) acc[month] = { income: 0, expense: 0 };
                    if (t.currency === 'CRC') { // Simplificaci√≥n para el gr√°fico
                        acc[month][t.type] += t.amount;
                    }
                    return acc;
                }, {});

                const labels = Object.keys(monthlyData).sort();
                if (this.state.charts.incomeExpense) this.state.charts.incomeExpense.destroy();
                this.state.charts.incomeExpense = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels,
                        datasets: [
                            { label: 'Ingresos (CRC)', data: labels.map(m => monthlyData[m].income), backgroundColor: 'rgba(0, 212, 170, 0.7)' },
                            { label: 'Gastos (CRC)', data: labels.map(m => monthlyData[m].expense), backgroundColor: 'rgba(244, 63, 94, 0.7)' }
                        ]
                    },
                    options: { responsive: true, maintainAspectRatio: false, scales: { y: { grid: { color: 'rgba(255,255,255,0.1)' } }, x: { grid: { color: 'rgba(255,255,255,0.1)' } } } }
                });
            }
        };

        document.addEventListener('DOMContentLoaded', () => KairuxH07.init());
    </script>
</body>
</html>